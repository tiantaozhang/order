
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">com.dy.order/orderwxpay/db.go (84.3%)</option>
				
				<option value="file1">com.dy.order/orderwxpay/wxpay_App_http.go (89.9%)</option>
				
				<option value="file2">com.dy.order/orderwxpay/wxpay_config.go (100.0%)</option>
				
				<option value="file3">com.dy.order/orderwxpay/wxpay_navite_http.go (87.1%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" >package orderwxpay

import (
        "com.dy.order/common"
        order "com.dy.order/orderModel"
        "errors"
        "github.com/Centny/gwf/log"
        //"github.com/Centny/gwf/routing"
        "fmt"
        //"org.cny.uap/sync"
)

func DealWXOrder(js WXRemoteReqStruct, ono, prepayId string) (string, error) <span class="cov8" title="1">{

        //sync uap
        if err := order.SynUser(js.Seller, js.Buyer); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>
        <span class="cov8" title="1">if prepayId == "" </span><span class="cov8" title="1">{
                return "", errors.New("prepayId nil")
        }</span>
        <span class="cov8" title="1">db := common.DbConn()
        tx, err := db.Begin()
        if err != nil </span><span class="cov0" title="0">{
                fmt.Printf("start a transaction err,%s\n", err.Error())
                return "", err
        }</span>
        //isOnoExist, isExistErr := order.CheckIsExist(db, js.Ono, 0, "ods_order")
        <span class="cov8" title="1">isOnoExist, _ := order.CheckIsExist(db, js.Ono, 0, "ods_order")
        //integral å‡å®š1=ï¼1åˆ†
        _, _needpay, _payway := order.PayTypeAndNeedPay(js.Integral, js.TotalFee)
        // _integral := float64(js.Integral) / 100.0
        // _needpay := js.TotalFee - _integral
        // _payway := 0 //0:æ­£å¸¸æ”¯ä»˜ 1:æœ‰ç§¯åˆ†æœ‰ğŸ’° 2:å…¨ç§¯åˆ†
        // js.TotalFee = _needpay
        // if 0 == _needpay {
        //         _payway = 2
        // } else if _needpay &gt; 0 &amp;&amp; js.Integral &gt; 0 {
        //         _payway = 1
        // }
        log.D("_payway:%v", _payway)
        //======ä»¥åä¼šæœ‰refund è¯·å‹¿åˆ é™¤=====
        // OrderType := js.Type
        // if OrderType == "REFUND" || OrderType == "refund" {
        //         log.D("Type Refund")
        //         if js.Ono == "" {
        //                 log.E("Ono is nil")
        //                 tx.Rollback()
        //                 return "", errors.New("Ono is nil")
        //         }
        //         if isOnoExist != true {
        //                 log.E("Ono is not exist in db")
        //                 tx.Rollback()
        //                 return "", errors.New("ono is not exist:" + isExistErr.Error())
        //         }
        //         for i := 0; i &lt; len(js.OrderItem); i++ {
        //                 if bl, _ := order.CheckIsExist(db, js.Ono, js.OrderItem[i].P_id, "ods_order_item"); bl != true {
        //                         log.E("ono or oid is not exist in order_item")
        //                         tx.Rollback()
        //                         return "", errors.New("ono or oid is not exist in order_item")
        //                 }
        //         }
        //         //æ›´æ”¹order_item
        //         for i := 0; i &lt; len(js.OrderItem); i++ {
        //                 _sql := `update ods_order_item set type ='REFUNG' where ono=? and p_id=?`
        //                 _, err = tx.Exec(_sql, js.OrderItem[i].Ono, js.OrderItem[i].P_id)
        //                 if err != nil {
        //                         log.E("exec order_item refund err")
        //                         tx.Rollback()
        //                         return "", err
        //                 }
        //         }

        //         //insert refund
        //         for i := 0; i &lt; len(js.OrderRefund); i++ {
        //                 _sql := `insert into ods_order_refund(ono,item,content,imgs,status) value(?,?,?,?,?)`
        //                 _, err = tx.Exec(_sql, js.OrderRefund[i].Ono, js.OrderRefund[i].Item, js.OrderRefund[i].Imgs, js.OrderRefund[i].Status)
        //                 if err != nil {
        //                         log.E("Add OrderItem error %v", err.Error())
        //                         tx.Rollback()
        //                         return "", err
        //                 }
        //         }
        //         //record
        //         //uid--&gt;buyer  target_id--&gt;seller
        //         if bl, err := order.InsertRecord(tx, js.Subject, "REFUND", js.TotalFee, js.Buyer, "ALIPAY", js.Seller, "USER", ono, "NOT_PAY"); bl != true {
        //                 return "", err
        //         }
        //         //uid--&gt;seller  target_id--&gt;buyer
        //         if bl, err := order.InsertRecord(tx, js.Subject, "REFUND", js.TotalFee, js.Seller, "ALIPAY", js.Buyer, "USER", ono, "NOT_PAY"); bl != true {
        //                 return "", err
        //         }

        // } else {
        log.D("Type N")
        if js.TotalFee &lt; 0 || (js.TotalFee == 0 &amp;&amp; js.Integral == 0) </span><span class="cov8" title="1">{
                log.E("æ¶ˆè´¹é‡‘é¢&lt;=0:%v", js.TotalFee)
                return "", errors.New("TotalFee error")
        }</span>
        //åŒä¸€è®¢å•
        <span class="cov8" title="1">if !isOnoExist </span><span class="cov8" title="1">{
                //insert item
                log.D("length orderItem:%d", len(js.OrderItem))
                log.D("%v", js.OrderItem)
                if len(js.OrderItem) &lt; 1 </span><span class="cov8" title="1">{
                        log.E("OrderItem is nil")
                        tx.Rollback()
                        return "", errors.New("OrderItem is nil")
                }</span>

                //detect paid_cb
                <span class="cov8" title="1">if err := order.CheckPaidcb(js.OrderItem[0].P_from); err != nil </span><span class="cov0" title="0">{
                        log.E("p_from err")
                        tx.Rollback()
                        return "", errors.New("p_from err")
                }</span>

                <span class="cov8" title="1">if err := order.InsertOrderItem(tx, order.CommonRemoteReqStruct(js), ono); err != nil </span><span class="cov8" title="1">{
                        log.E("InsertOrderItem err:%v", err.Error())
                        return "", err
                }</span>

                // for i := 0; i &lt; len(js.OrderItem); i++ {
                //         _sql := `insert into ods_order_item(ono,oid,p_name,p_id,p_type,p_img,p_count,p_from,notified,price,type,status) value(?,?,?,?,?,?,?,?,?,?,?,?)`
                //         _, err = tx.Exec(_sql, ono, js.OrderItem[i].Oid, js.OrderItem[i].P_name, js.OrderItem[i].P_id, js.OrderItem[i].P_type, js.OrderItem[i].P_img, js.OrderItem[i].P_count, js.OrderItem[i].P_from, js.OrderItem[i].Notified, js.OrderItem[i].Price, js.Type, js.OrderItem[i].Status)
                //         if err != nil {
                //                 log.E("Add OrderItem error %v", err.Error())
                //                 tx.Rollback()
                //                 return "", err
                //         }
                // }
                //_payway 0:æ­£å¸¸æ”¯ä»˜ 1:æœ‰ç§¯åˆ†æœ‰ğŸ’° 2:å…¨ç§¯åˆ†
                <span class="cov8" title="1">if 2 == _payway || 1 == _payway </span><span class="cov8" title="1">{
                        //uid--&gt;buyer  target_id--&gt;seller
                        if err := order.InsertWithIntegral(tx, order.CommonRemoteReqStruct(js), ono); err != nil </span><span class="cov8" title="1">{
                                log.E("InsertWithIntegral: %v", err.Error())
                                return "", err
                        }</span>
                }
                <span class="cov8" title="1">if 0 == _payway || 1 == _payway </span><span class="cov8" title="1">{
                        //record
                        //uid--&gt;buyer  target_id--&gt;seller
                        // if bl, err := order.InsertRecord(tx, js.Subject, "INCOME", _needpay, js.Buyer, "WXPAY", js.Seller, "USER", ono, "NOT_PAY"); bl != true {
                        //         return "", err
                        // }
                        // //uid--&gt;seller  target_id--&gt;buyer
                        // if bl, err := order.InsertRecord(tx, js.Subject, "PAY", _needpay, js.Seller, "WXPAY", js.Buyer, "USER", ono, "NOT_PAY"); bl != true {
                        //         return "", err
                        // }

                        if err := order.InsertWithRMB(tx, order.CommonRemoteReqStruct(js), ono, _needpay, "WXPAY"); err != nil </span><span class="cov8" title="1">{
                                log.E("InsertWithRMB: %v", err.Error())
                                return "", err
                        }</span>
                }
        }
        // }
        //insert order
        //        status := "NOT_PAY"
        <span class="cov8" title="1">if !isOnoExist </span><span class="cov8" title="1">{
                _sql := `insert into ods_order(ono,buyer,seller,total_price,type,status,return_url,expand,wno) value(?,?,?,?,?,?,?,?,?)`
                _, err = tx.Exec(_sql, ono, js.Buyer, js.Seller, js.TotalFee, js.Type, js.Status, js.Return_url, js.Expand, prepayId)
                if err != nil </span><span class="cov8" title="1">{
                        log.E("Add Order error %v", err.Error())
                        tx.Rollback()
                        return "", err
                }</span>
        }
        <span class="cov8" title="1">err = tx.Commit()
        if err != nil </span><span class="cov0" title="0">{
                log.E("AddOrder commit error %v", err.Error())
                tx.Rollback()
                return "", err
        }</span>
        <span class="cov8" title="1">return "", nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package orderwxpay

import (
        //"encoding/json"
        "com.dy.order/common"
        order "com.dy.order/orderModel"
        "com.dy.wxpkg/wechatPay"
        "encoding/json"
        "errors"
        "fmt"
        "github.com/Centny/gwf/log"
        "github.com/Centny/gwf/routing"
        "io/ioutil"
        //"net/http"
        "strconv"
        "time"
)

// å‘é€è¯·æ±‚
/*
æ­¤å‡½æ•°åªåšæµ‹è¯•ç”¨,å‹¿ä½¿ç”¨ä¹Ÿå‹¿åˆ 
*/
// func WxPayApp(w http.ResponseWriter, r *http.Request) {
//         log.D("WxPayApp Begin")

//         u := wechatPay.NewUnifiedorder(wechatPay.GWxPayConfig)
//         // éšæœºå­—ç¬¦ä¸²
//         u.Nonce_str = wechatPay.Md5String(wechatPay.NewOrderNo())
//         // å•†å“æè¿°
//         u.Body = "testWXPay"
//         // å•†æˆ·è®¢å•å·
//         u.Out_trade_no = wechatPay.NewOrderNo()
//         // æ€»é‡‘é¢
//         u.Total_fee = "1"
//         // ç»ˆç«¯IP
//         u.Spbill_create_ip = "127.0.0.1"
//         // é€šçŸ¥åœ°å€ Config ç»Ÿä¸€é…ç½®  æ¥æ”¶å¾®ä¿¡æ”¯ä»˜å¼‚æ­¥é€šçŸ¥å›è°ƒåœ°å€ï¼Œé€šçŸ¥urlå¿…é¡»ä¸ºç›´æ¥å¯è®¿é—®çš„urlï¼Œä¸èƒ½æºå¸¦å‚æ•°ã€‚
//         // u.Notify_url = "xxxx://xxx.xxx.xxx.xxx"
//         // äº¤æ˜“ç±»å‹  JSAPI--å…¬ä¼—å·æ”¯ä»˜ã€NATIVE--åŸç”Ÿæ‰«ç æ”¯ä»˜ã€APP--appæ”¯ä»˜  MICROPAY--åˆ·å¡æ”¯ä»˜
//         u.Trade_type = "APP"
//         // å•†å“ID
//         u.Product_id = "123456"
//         //====== é€‰å¡«
//         // è®¾å¤‡å·
//         u.Device_info = "123456"
//         // å•†å“è¯¦æƒ…
//         u.Detail = "xxoo xxoo"
//         // é™„åŠ æ•°æ®
//         //u.Attach = "ä½ å¤§çˆ·æˆ‘"
//         // è´§å¸ç±»å‹
//         //u.Fee_type = "CNY"
//         // äº¤æ˜“èµ·å§‹æ—¶é—´  è®¢å•ç”Ÿæˆæ—¶é—´ï¼Œæ ¼å¼ä¸ºyyyyMMddHHmmssï¼Œå¦‚2009å¹´12æœˆ25æ—¥9ç‚¹10åˆ†10ç§’è¡¨ç¤ºä¸º20091225091010ã€‚
//         // u.Time_start = "xxxxxxxxx"
//         // äº¤æ˜“ç»“æŸæ—¶é—´   è®¢å•å¤±æ•ˆæ—¶é—´ï¼Œæ ¼å¼ä¸ºyyyyMMddHHmmssï¼Œå¦‚2009å¹´12æœˆ27æ—¥9ç‚¹10åˆ†10ç§’è¡¨ç¤ºä¸º20091227091010ã€‚æ³¨æ„ï¼šæœ€çŸ­å¤±æ•ˆæ—¶é—´é—´éš”å¿…é¡»å¤§äº5åˆ†é’Ÿ
//         // u.Time_expire = "xxxxxxxxx"
//         // å•†å“æ ‡è®°
//         //u.Goods_tag = "è¶…ğŸ‚B"
//         // æŒ‡å®šæ”¯ä»˜æ–¹å¼
//         //u.Limit_pay = "no_credit"
//         // ç”¨æˆ·æ ‡è¯†
//         // u.Openid = "æ²¡æ ‡è¯†"

//         uresp, err := u.TakeOrder(wechatPay.GWxPayConfig)
//         if err != nil {
//                 //HttpRespE(w, err.Error(), 500)
//                 HttpRespJE(w, err.Error())
//                 return
//         }
//         //write database

//         //app
//         jp, err := u.GenPayReq(wechatPay.GWxPayConfig, uresp.Prepay_id, u.Out_trade_no)
//         if err != nil {
//                 //HttpRespE(w, err.Error(), 500)
//                 HttpRespJE(w, err.Error())
//                 return
//         }
//         HttpResp(w, string(jp))

//         return
// }

//WxMoblieRemoteCall
//weixin pay
//
//
//@url,remote request
// WXRemoteReqStruct json
//@arg,æ¥å£å‚æ•°çš„è¯¦ç»†æè¿°
//  req    R    WXRemoteReqStruct json

/*
   {//æ ·ä¾‹æ•°æ®
               m := WXRemoteReqStruct{
                        Ono:        "",
                        Buyer:      267250,
                        Seller:     438982,
                        Subject:    "testWXPay",
                        TotalFee:   fee,
                        Body:       "test",
                        Type:       "N",
                        Status:     "NOT_PAY",
                        Return_url: "http://rcp.dev.jxzy.com/courseDetail.html?id=40040",
                        Expand:     "id=40040&amp;token=4d42bf9c18cb04139f918ff0ae68f8a0-fd724b48-caf7-4151-932b-dab86282ab35",
                }
                for i := 1; i &lt; 3; i++ {
                        stri := fmt.Sprintf("%d", i)
                        str := "ç‰©å“" + stri
                        orderi := orderModel.Item{
                                Ono:      "",
                                Oid:      int64(i),
                                P_name:   str,
                                P_id:     int64(i),
                                P_type:   "",
                                P_img:    `http://image.baidu.com/search/detail?ct=503316480&amp;z=0&amp;ipn=d&amp;word=%E7%99%BE%E5%BA%A6%E5%9B%BE%E7%89%87&amp;pn=2&amp;spn=0&amp;di=171315887930&amp;pi=&amp;rn=1&amp;tn=baiduimagedetail&amp;ie=utf-8&amp;oe=utf-8&amp;cl=2&amp;lm=-1&amp;cs=1879444470%2C3904781009&amp;os=340336596%2C2044119696&amp;simid=4219135247%2C874483244&amp;adpicid=0&amp;ln=30&amp;fr=ala&amp;sme=&amp;cg=&amp;bdtype=0&amp;objurl=http%3A%2F%2Fd.hiphotos.baidu.com%2Fzhidao%2Fpic%2Fitem%2F6d81800a19d8bc3e4a4c8226838ba61ea9d34592.jpg&amp;fromurl=ippr_z2C%24qAzdH3FAzdH3Fzit1w5_z%26e3Bkwt17_z%26e3Bv54AzdH3Fq7jfpt5gAzdH3Fc0lclac9l_z%26e3Bip4s&amp;gsm=0`,
                                P_count:  1,
                                P_from:   "TEST",
                                Notified: 0,
                                Price:    0.01,
                                Type:     "N",
                                Status:   "N",
                        }
                        m.OrderItem = append(m.OrderItem, orderi)
                }
   }
*/
//@ret,æ¥å£è¿”å›æ•°æ®æè¿°
//  str  S   string
//  err  O   error

//@tag,å¾®ä¿¡æ”¯ä»˜è¿œç¨‹è°ƒç”¨
//@author,zhang,2016-02-18

func WxMoblieRemoteCall(req string) (string, error) <span class="cov8" title="1">{

        var err error

        log.D("begin WxMoblieRemoteCall remote request", "heheda")
        fmt.Printf("req:%s\n", []byte(req))
        var js WXRemoteReqStruct
        err = json.Unmarshal([]byte(req), &amp;js)
        if err != nil </span><span class="cov8" title="1">{
                log.E("format err")
                return "", err
        }</span>
        <span class="cov8" title="1">fmt.Printf("js:%s\n", js)

        if err := order.CheckParas(order.CommonRemoteReqStruct(js)); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>

        //detect integral
        <span class="cov8" title="1">if err = order.DetectIntegral(common.DbConn(), js.Integral, js.Buyer, js.TotalFee); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>
        //conv totalfee
        <span class="cov8" title="1">log.D("integral:%f,%f", js.TotalFee, float64(js.Integral)/100.0)
        _integral := float64(js.Integral) / 100.0
        _needpay := js.TotalFee - _integral
        s := fmt.Sprintf("%.2f", _needpay)
        i, err := strconv.ParseFloat(s, 64)
        if err != nil </span><span class="cov0" title="0">{
                return "", errors.New("TotalFee err")
        }</span>

        <span class="cov8" title="1">u := wechatPay.NewUnifiedorder(wechatPay.GWxPayConfig)
        // éšæœºå­—ç¬¦ä¸²
        u.Nonce_str = wechatPay.Md5String(wechatPay.NewOrderNo())
        // å•†å“æè¿°
        u.Body = js.Subject
        // å•†æˆ·è®¢å•å·
        u.Out_trade_no = wechatPay.NewOrderNo()
        // æ€»é‡‘é¢
        u.Total_fee = fmt.Sprintf("%d", int(i*100))
        // ç»ˆç«¯IP
        u.Spbill_create_ip = "127.0.0.1"
        // äº¤æ˜“ç±»å‹  JSAPI--å…¬ä¼—å·æ”¯ä»˜ã€NATIVE--åŸç”Ÿæ‰«ç æ”¯ä»˜ã€APP--appæ”¯ä»˜  MICROPAY--åˆ·å¡æ”¯ä»˜
        u.Trade_type = "APP"
        //detail
        u.Detail = js.Body
        //js.Ono = u.Out_trade_no
        fmt.Printf("Total_fee:%s\n", u.Total_fee)

        //sync uap
        // if err := order.SynUser(js.Seller, js.Buyer); err != nil {
        //         return "", err
        // }
        if js.TotalFee &lt; 0 || (js.TotalFee == 0 &amp;&amp; js.Integral == 0) </span><span class="cov8" title="1">{
                return "", errors.New("invalid total_fee")
        }</span>

        //å…¨ç§¯åˆ†æš‚ä¸æ”¯æŒ
        <span class="cov8" title="1">uresp, err := u.TakeOrder(wechatPay.GWxPayConfig)
        if err != nil </span><span class="cov0" title="0">{
                log.E("TakeOrder err:", err.Error())
                return "", err
        }</span>

        <span class="cov8" title="1">if _, err := DealWXOrder(js, u.Out_trade_no, uresp.Prepay_id); err != nil </span><span class="cov8" title="1">{
                log.E("DealWXOrder err:", err.Error())
                return "", err
        }</span>
        //app
        <span class="cov8" title="1">returnJs, err := u.GenPayReq(wechatPay.GWxPayConfig, uresp.Prepay_id, u.Out_trade_no)
        if err != nil </span><span class="cov0" title="0">{
                log.E("GenPayReq err:", err.Error())
                return "", err
        }</span>
        <span class="cov8" title="1">return string(returnJs), nil</span>

}

//æ¥æ”¶é€šçŸ¥
// func WxPayAppNotify(w http.ResponseWriter, r *http.Request) {
//         log.D("WxPayAppNotify Begin")

//         n := &amp;wechatPay.NotyfyCallback{}
//         n.Return_code = "FAIL"
//         defer func() {
//                 log.D("WxPayAppNotify End")
//                 log.D("NotyfyCallback to WX : ", n.ToXML())
//                 w.Header().Set("Content-Type", "application/xml ")
//                 fmt.Fprint(w, n.ToXML())
//         }()

//         bodyByte, _ := ioutil.ReadAll(r.Body)
//         u, sbool, err := wechatPay.NewNaviteNotify(bodyByte, wechatPay.GWxPayConfig)
//         if err != nil {
//                 log.D("è§£æå¾®ä¿¡è¯·æ±‚é”™è¯¯ : ", err)
//                 return
//         }
//         if !sbool {
//                 log.D("éªŒè¯å¾®ä¿¡ç­¾åé”™è¯¯ : ", err)
//                 return
//         }

//         log.D("åœ¨è¿™å¤„ç†è®¢å•")
//         log.D("Out_trade_no : ", u.Out_trade_no)

//         n.Return_code = "SUCCESS"
//         n.Return_msg = "OK"
//         return
// }

//æ¥æ”¶å¾®ä¿¡å›è°ƒé€šçŸ¥
func WxPayMoblieNotify(hs *routing.HTTPSession) routing.HResult <span class="cov8" title="1">{
        log.D("WxPayAppNotify Begin")

        n := &amp;wechatPay.NotyfyCallback{}
        n.Return_code = "FAIL"
        defer func() </span><span class="cov8" title="1">{
                log.D("WxPayAppNotify End")
                log.D("NotyfyCallback to WX : ", n.ToXML())
                hs.W.Header().Set("Content-Type", "application/xml ")
                fmt.Fprint(hs.W, n.ToXML())
        }</span>()

        <span class="cov8" title="1">bodyByte, _ := ioutil.ReadAll(hs.R.Body)

        u, sbool, err := wechatPay.NewNaviteNotify(bodyByte, wechatPay.GWxPayConfig)
        if err != nil </span><span class="cov0" title="0">{
                log.E("è§£æå¾®ä¿¡è¯·æ±‚é”™è¯¯ : ", err)
                return routing.HRES_RETURN
        }</span>
        <span class="cov8" title="1">if !sbool </span><span class="cov8" title="1">{
                log.E("éªŒè¯å¾®ä¿¡ç­¾åé”™è¯¯ : ", err)
                return routing.HRES_RETURN
        }</span>

        <span class="cov8" title="1">status := "PAID"
        log.D("trade_status is : %v ", u.Result_code)
        log.D("total_fee is %v ", u.Total_fee)
        log.D("Out_trade_no %v: ", u.Out_trade_no)
        log.D("Transaction_id:", u.Transaction_id)

        log.D("MOBILEPAY TRADE_SUCCESS,å¤„ç†è®¢å•ä¸­...")
        if bl, _ := WXpayPaySuccess(u.Out_trade_no, status, u.Transaction_id); bl != true </span><span class="cov8" title="1">{
                IfWXPaySuccessFail(u.Out_trade_no, status, u.Transaction_id)
        }</span>

        <span class="cov8" title="1">n.Return_code = "SUCCESS"
        n.Return_msg = "OK"
        return routing.HRES_RETURN</span>

}

/*
func: paid failed
*/
func IfWXPaySuccessFail(ono string, status string, transaction_id string) <span class="cov8" title="1">{
        //        conn = dbMgr.DbConn()
        log.D("æ•°æ®åº“å‡ºé”™ï¼Œåç»­å¤„ç†ä¸­")
        go func() </span><span class="cov8" title="1">{
                timer := time.NewTicker(15 * time.Second)
                i := 0
        breakf:
                for </span><span class="cov8" title="1">{
                        select </span>{
                        <span class="cov8" title="1">case &lt;-timer.C:
                                if i &lt; 3 </span><span class="cov8" title="1">{
                                        log.D("the %d times ccb wx fail", i)
                                        i++
                                }</span><span class="cov0" title="0"> else {
                                        log.D("kill timer wx fail")
                                        timer.Stop()
                                        break breakf</span>
                                }
                                <span class="cov8" title="1">if bl, _ := WXpayPaySuccess(ono, status, transaction_id); bl </span><span class="cov8" title="1">{
                                        log.D("success ccb wx fail")
                                        timer.Stop()
                                        break breakf</span>
                                }
                        }
                }
        }()
}

/*
func:after pay success,but not refund
*/
func WXpayPaySuccess(ono string, status string, transaction_id string) (bool, error) <span class="cov8" title="1">{
        callback := false
        defer func() </span><span class="cov8" title="1">{
                if callback == true </span><span class="cov8" title="1">{
                        if bl, _ := order.Callback(ono); bl != true </span><span class="cov8" title="1">{
                                log.D("callback=false")
                                go func(ono string) </span><span class="cov8" title="1">{
                                        log.D("å›è°ƒå‡ºé”™ï¼Œåç»­å¤„ç†ä¸­")
                                        timer := time.NewTicker(3 * time.Second)
                                        i := 0
                                breakf:
                                        for </span><span class="cov8" title="1">{
                                                select </span>{
                                                <span class="cov8" title="1">case &lt;-timer.C:
                                                        if i &gt;= 5 </span><span class="cov8" title="1">{
                                                                timer.Stop()
                                                                log.D("kill timer wx")
                                                                break breakf</span>
                                                        }<span class="cov8" title="1"> else {
                                                                log.D("the %d times ccb wx", i)
                                                                i++
                                                        }</span>
                                                        <span class="cov8" title="1">if bl, _ := order.Callback(ono); bl </span><span class="cov0" title="0">{
                                                                log.D("success ccb wx")
                                                                timer.Stop()
                                                                break breakf</span>
                                                        }
                                                }
                                        }
                                }(ono)
                        }<span class="cov0" title="0"> else {
                                log.D("callback=true")
                        }</span>
                }
        }()

        <span class="cov8" title="1">db := common.DbConn()
        tx, _ := db.Begin()
        var uid int64
        var target_id int64
        // var imoney float64
        // var buyer int64
        _sql := `select buyer,seller from  ods_order o join ods_record r  where r.ono=o.ono and r.ono =? order by r.tid asc`
        err := tx.QueryRow(_sql, ono).Scan(&amp;uid, &amp;target_id)
        //err1 := tx.QueryRow(_sql, ono).Scan(&amp;target_id)
        if err != nil /*|| err1 != nil*/ </span><span class="cov8" title="1">{
                log.E("Query ods_record uid ,target_id error %v", err.Error())
                tx.Rollback()
                return false, errors.New("Query record uid,target_id error")
        }</span>
        <span class="cov8" title="1">if uid == 0 || target_id == 0 </span><span class="cov8" title="1">{
                log.E("uid or target_id not exist")
                tx.Rollback()
                return false, errors.New("uid or target not exist")
        }</span>

        //integral ç§¯åˆ†æš‚ä¸æ”¯æŒ
        //_n_integral := ^js.Integral + 1
        // _sql = `select r.money,o.buyer from ods_record r join ods_order o on r.uid=o.buyer and r.ono=o.ono  where o.ono=? and r.pay_type='å¤§æ´‹å¸'`
        // err = tx.QueryRow(_sql, ono).Scan(&amp;imoney, &amp;buyer)
        // if err != nil {
        //         log.E("Query ods_record money error %v", err.Error())
        //         tx.Rollback()
        //         return false, errors.New("Query ods_record money error")
        // }
        // _n_integral := ^int64(imoney) + 1
        // if bl, err := order.UpdateIntegral(tx, _n_integral, buyer); bl != true {
        //         log.E("UpdateIntegral: %v", err.Error())
        //         return false, err
        // }
        //buyer--&gt;uid  record
        <span class="cov8" title="1">Type := "PAID"
        sts := "PAID"
        if bl, err := order.UpdateRecord(tx, Type, sts, uid, ono); bl != true </span><span class="cov8" title="1">{
                return false, err
        }</span>
        //seller--&gt;uid  record
        <span class="cov8" title="1">Type = "INCOME"
        if bl, err := order.UpdateRecord(tx, Type, sts, target_id, ono); bl != true </span><span class="cov0" title="0">{
                return false, err
        }</span>

        <span class="cov8" title="1">_sql = `update ods_order set status=? where ono =?`
        _, err = tx.Exec(_sql, status, ono)
        if err != nil </span><span class="cov8" title="1">{
                log.E("Add ods_record error %v", err.Error())
                tx.Rollback()
                return false, err
        }</span>

        <span class="cov8" title="1">_sql = `update ods_order set wno=? where ono =?`
        _, err = tx.Exec(_sql, transaction_id, ono)
        if err != nil </span><span class="cov8" title="1">{
                log.E("Add ods_record error %v", err.Error())
                tx.Rollback()
                return false, err
        }</span>

        <span class="cov8" title="1">err = tx.Commit()
        if err != nil </span><span class="cov8" title="1">{
                log.E("AlipayPaySuccess commit error %v", err.Error())
                tx.Rollback()
                return false, err
        }</span>
        <span class="cov8" title="1">callback = true
        return true, nil</span>

}
</pre>
		
		<pre class="file" id="file2" style="display: none">package orderwxpay

import (
        "com.dy.order/conf"
        om "com.dy.order/orderModel"
        "com.dy.wxpkg/wechatPay"
        "fmt"
)

func InitWxConfig() <span class="cov8" title="1">{
        host := conf.Order_host()
        wechatPay.GWxPayConfig.Notify_url = fmt.Sprintf("http://%v/wxpay-mobile-notify", host)
        wechatPay.GWxNativePayConfig.Notify_url = fmt.Sprintf("http://%v/wxpay-native-notify", host)
}</span>

type Result struct {
        Ret    int
        Reason string
        Data   interface{}
}

type WXRemoteReqStruct struct {
        Ono      string  `json:"ono"`
        Buyer    int64   `json:"buyer"`
        Seller   int64   `json:"seller"`
        Subject  string  `json:"subject"`
        TotalFee float64 `json:"totalFee"`
        Body     string  `json:"body"`
        //        ShowUrl  string  `json:showUrl`
        Type   string `json:"type"`
        Status string `json:"status"`
        // url  extern
        Return_url string `json:"return_url"`
        Expand     string `json:"expand"`
        //integral
        Integral int64 `json:"integral"`
        //order_item
        OrderItem []om.Item `json:"item"`
        //        OrderEnv    Env      `json:env`
        OrderRefund []om.Refund `json:"refund"`
}

type Order struct {
        Buyer    string  `json:"buyer"`
        Seller   string  `json:"seller"`
        TotalFee float64 `json:"totalFee"`
        //        ShowUrl  string  `json:showUrl`
        Type string `json:"type"`
}

type Item struct {
        Ono      string  `json:"ono"`
        Oid      int64   `json:"oid"`
        P_name   string  `json:"p_name"`
        P_id     int64   `json:"p_id"`
        P_type   string  `json:"p_type"`
        P_img    string  `json:"p_img"`
        P_count  int64   `json:"p_count"`
        P_from   string  `json:"p_from"`
        Notified int64   `json:"notified"`
        Price    float64 `json:"price"`
        Type     string  `json:"type"`
        Status   string  `json:"status"`
}

type Refund struct {
        Ono     string `json:"ono"`
        Item    int64  `json:"item"`
        Content string `json:"content"`
        Imgs    string `json:"imgs"`
        Status  string `json:"status"`
}

type Env struct {
        Akey   string `json:"akey"`
        Aval   string `json:"aval"`
        Type   string `json:"type"`
        Status string `json:"status"`
}

type Record struct {
        Name        string `json:"name"`
        Type        string `json:"type"`
        Money       string `json:"money"`
        Uid         string `json:"uid"`
        Pay_type    string `json:"pay_type"`
        Target_id   string `json:"target_id"`
        Target_type string `json:"target_type"`
        Ono         string `json:"ono"`
        Status      string `json:"status"`
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package orderwxpay

import (
        "com.dy.order/common"
        order "com.dy.order/orderModel"
        "com.dy.order/orderQr"
        "com.dy.wxpkg/wechatPay"
        "encoding/json"
        "errors"
        "fmt"
        "github.com/Centny/gwf/log"
        "github.com/Centny/gwf/routing"
        "io/ioutil"
        //        "net/http"
        "strconv"
)

// func HttpRespE(w http.ResponseWriter, msg string, code int) {
//         http.Error(w, msg, code)
// }

// func HttpRespJE(w http.ResponseWriter, msg string) {
//         msgerr := map[string]interface{}{}
//         msgerr["code"] = "1"
//         msgerr["data"] = msg
//         msgbyte, _ := json.Marshal(msgerr)
//         w.Write([]byte(msgbyte))
// }

// func HttpResp(w http.ResponseWriter, msg string) {
//         w.Write([]byte(msg))
// }

// å‘é€è¯·æ±‚
// func WxPayNavite(w http.ResponseWriter, r *http.Request) {
//         log.D("WxPayNavite Begin")

//         u := wechatPay.NewUnifiedorder(wechatPay.GWxPayConfig)
//         // éšæœºå­—ç¬¦ä¸²
//         u.Nonce_str = wechatPay.Md5String(wechatPay.NewOrderNo())
//         // å•†å“æè¿°
//         u.Body = "testWXPay"
//         // å•†æˆ·è®¢å•å·
//         u.Out_trade_no = wechatPay.NewOrderNo()
//         // æ€»é‡‘é¢
//         u.Total_fee = "1"
//         // ç»ˆç«¯IP
//         u.Spbill_create_ip = "127.0.0.1"
//         // é€šçŸ¥åœ°å€ Config ç»Ÿä¸€é…ç½®  æ¥æ”¶å¾®ä¿¡æ”¯ä»˜å¼‚æ­¥é€šçŸ¥å›è°ƒåœ°å€ï¼Œé€šçŸ¥urlå¿…é¡»ä¸ºç›´æ¥å¯è®¿é—®çš„urlï¼Œä¸èƒ½æºå¸¦å‚æ•°ã€‚
//         // u.Notify_url = "xxxx://xxx.xxx.xxx.xxx"
//         // äº¤æ˜“ç±»å‹  JSAPI--å…¬ä¼—å·æ”¯ä»˜ã€NATIVE--åŸç”Ÿæ‰«ç æ”¯ä»˜ã€APP--appæ”¯ä»˜  MICROPAY--åˆ·å¡æ”¯ä»˜
//         u.Trade_type = "NATIVE"
//         //u.Trade_type = "APP"
//         // å•†å“ID
//         u.Product_id = "123456"
//         //====== é€‰å¡«
//         // è®¾å¤‡å·
//         u.Device_info = "123456"
//         // å•†å“è¯¦æƒ…
//         u.Detail = "xxoo xxoo"
//         // é™„åŠ æ•°æ®
//         //u.Attach = "ä½ å¤§çˆ·æˆ‘"
//         // è´§å¸ç±»å‹
//         //u.Fee_type = "CNY"
//         // äº¤æ˜“èµ·å§‹æ—¶é—´  è®¢å•ç”Ÿæˆæ—¶é—´ï¼Œæ ¼å¼ä¸ºyyyyMMddHHmmssï¼Œå¦‚2009å¹´12æœˆ25æ—¥9ç‚¹10åˆ†10ç§’è¡¨ç¤ºä¸º20091225091010ã€‚
//         // u.Time_start = "xxxxxxxxx"
//         // äº¤æ˜“ç»“æŸæ—¶é—´   è®¢å•å¤±æ•ˆæ—¶é—´ï¼Œæ ¼å¼ä¸ºyyyyMMddHHmmssï¼Œå¦‚2009å¹´12æœˆ27æ—¥9ç‚¹10åˆ†10ç§’è¡¨ç¤ºä¸º20091227091010ã€‚æ³¨æ„ï¼šæœ€çŸ­å¤±æ•ˆæ—¶é—´é—´éš”å¿…é¡»å¤§äº5åˆ†é’Ÿ
//         // u.Time_expire = "xxxxxxxxx"
//         // å•†å“æ ‡è®°
//         //u.Goods_tag = "è¶…ğŸ‚B"
//         // æŒ‡å®šæ”¯ä»˜æ–¹å¼
//         //u.Limit_pay = "no_credit"
//         // ç”¨æˆ·æ ‡è¯†
//         // u.Openid = "æ²¡æ ‡è¯†"

//         uresp, err := u.TakeOrder(wechatPay.GWxPayConfig)
//         if err != nil {
//                 HttpRespE(w, err.Error(), 500)
//                 return
//         }

//         HttpResp(w, uresp.Code_url)

//         return
// }

/*
remote call
å‚æ•°: WXRemoteReqStruct json
è¿”å›ï¼šstring
*/
func WxNativeRemoteCall(req string) (string, error) <span class="cov8" title="1">{

        var err error

        log.D("begin WxNativeRemoteCall remote request")
        fmt.Printf("req:%s\n", []byte(req))
        var js WXRemoteReqStruct
        err = json.Unmarshal([]byte(req), &amp;js)
        if err != nil </span><span class="cov8" title="1">{
                log.E("format err")
                return "", err
        }</span>
        <span class="cov8" title="1">fmt.Printf("js:%s\n", js)

        if err := order.CheckParas(order.CommonRemoteReqStruct(js)); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>

        //detect integral
        <span class="cov8" title="1">if err = order.DetectIntegral(common.DbConn(), js.Integral, js.Buyer, js.TotalFee); err != nil </span><span class="cov8" title="1">{
                return "", err
        }</span>
        <span class="cov8" title="1">log.D("integral:%f,%f", js.TotalFee, float64(js.Integral)/100.0)
        _integral := float64(js.Integral) / 100.0
        _needpay := js.TotalFee - _integral
        s := fmt.Sprintf("%.2f", _needpay)
        i, err := strconv.ParseFloat(s, 64)
        if err != nil </span><span class="cov0" title="0">{
                return "", errors.New("TotalFee err")
        }</span>

        <span class="cov8" title="1">u := wechatPay.NewUnifiedorder(wechatPay.GWxNativePayConfig)
        // éšæœºå­—ç¬¦ä¸²
        u.Nonce_str = wechatPay.Md5String(wechatPay.NewOrderNo())
        // å•†å“æè¿°
        u.Body = js.Subject
        // å•†æˆ·è®¢å•å·
        u.Out_trade_no = wechatPay.NewOrderNo()
        // // æ€»é‡‘é¢
        u.Total_fee = fmt.Sprintf("%d", int(i*100))
        // // ç»ˆç«¯IP
        u.Spbill_create_ip = "127.0.0.1"
        // // äº¤æ˜“ç±»å‹  JSAPI--å…¬ä¼—å·æ”¯ä»˜ã€NATIVE--åŸç”Ÿæ‰«ç æ”¯ä»˜ã€APP--appæ”¯ä»˜  MICROPAY--åˆ·å¡æ”¯ä»˜
        u.Trade_type = "NATIVE"
        // // å•†å“ID
        //u.Product_id = "123456"
        // //detail
        u.Detail = js.Body
        //u.Device_info = "123456"
        // //js.Ono = u.Out_trade_no
        fmt.Printf("Total_fee:%s\n", u.Total_fee)

        //sync uap
        // if err := order.SynUser(js.Seller, js.Buyer); err != nil {
        //         return "", err
        // }
        //é¢„å…ˆæ£€æµ‹
        if js.TotalFee &lt; 0 || (js.TotalFee == 0 &amp;&amp; js.Integral == 0) </span><span class="cov8" title="1">{
                return "", errors.New("invalid total_fee")
        }</span>

        //å…¨ç§¯åˆ†æš‚ä¸æ”¯æŒ
        <span class="cov8" title="1">uresp, err := u.TakeOrder(wechatPay.GWxNativePayConfig)
        if err != nil </span><span class="cov0" title="0">{
                log.E("TakeOrder err:", err.Error())
                return "", err
        }</span>

        <span class="cov8" title="1">if _, err := DealWXOrder(js, u.Out_trade_no, uresp.Prepay_id); err != nil </span><span class="cov0" title="0">{
                log.E("DealWXOrder err:", err.Error())
                return "", err
        }</span>

        //qr gen
        <span class="cov8" title="1">data, err := orderQr.GenQr(uresp.Code_url, u.Out_trade_no)
        if err != nil </span><span class="cov0" title="0">{
                log.E("genQr err:%s", err.Error())
                return "", err
        }</span>

        <span class="cov8" title="1">return data, nil</span>

}

//æ¥æ”¶é€šçŸ¥
// func WxPayNaviteNotify(w http.ResponseWriter, r *http.Request) {
//         log.D("WxPayNaviteNotify Begin")

//         n := &amp;wechatPay.NotyfyCallback{}
//         n.Return_code = "FAIL"
//         defer func() {
//                 log.D("WxPayNaviteNotify End")
//                 log.D("NotyfyCallback to WX : %v", n.ToXML())
//                 w.Header().Set("Content-Type", "application/xml ")
//                 fmt.Fprint(w, n.ToXML())
//         }()

//         bodyByte, _ := ioutil.ReadAll(r.Body)
//         u, sbool, err := wechatPay.NewNaviteNotify(bodyByte, wechatPay.GWxPayConfig)
//         if err != nil {
//                 log.D("è§£æå¾®ä¿¡è¯·æ±‚é”™è¯¯ : ", err)
//                 return
//         }
//         if !sbool {
//                 log.D("éªŒè¯å¾®ä¿¡ç­¾åé”™è¯¯ : ", err)
//                 return
//         }

//         log.D("åœ¨è¿™å¤„ç†è®¢å•")
//         log.D("Out_trade_no : ", u.Out_trade_no)
//         n.Return_code = "SUCCESS"
//         return
// }

func WxPayWebNotify(hs *routing.HTTPSession) routing.HResult <span class="cov8" title="1">{
        log.D("WxPayWebNotify Begin")

        n := &amp;wechatPay.NotyfyCallback{}
        n.Return_code = "FAIL"
        defer func() </span><span class="cov8" title="1">{
                log.D("WxPayAppNotify End")
                log.D("NotyfyCallback to WX : ", n.ToXML())
                hs.W.Header().Set("Content-Type", "application/xml ")
                fmt.Fprint(hs.W, n.ToXML())
        }</span>()

        <span class="cov8" title="1">bodyByte, _ := ioutil.ReadAll(hs.R.Body)
        u, sbool, err := wechatPay.NewNaviteNotify(bodyByte, wechatPay.GWxNativePayConfig)
        if err != nil </span><span class="cov0" title="0">{
                log.E("è§£æå¾®ä¿¡è¯·æ±‚é”™è¯¯ : ", err)
                return routing.HRES_RETURN
        }</span>
        <span class="cov8" title="1">if !sbool </span><span class="cov8" title="1">{
                log.E("éªŒè¯å¾®ä¿¡ç­¾åé”™è¯¯ : ", err)
                return routing.HRES_RETURN
        }</span>

        <span class="cov8" title="1">status := "PAID"
        log.D("trade_status is : %v ", u.Result_code)
        log.D("total_fee is %v ", u.Total_fee)
        log.D("Out_trade_no %v: ", u.Out_trade_no)
        log.D("Transaction_id:", u.Transaction_id)

        log.D("MOBILEPAY TRADE_SUCCESS,å¤„ç†è®¢å•ä¸­...")
        if bl, _ := WXpayPaySuccess(u.Out_trade_no, status, u.Transaction_id); bl != true </span><span class="cov8" title="1">{
                IfWXPaySuccessFail(u.Out_trade_no, status, u.Transaction_id)
        }</span>

        <span class="cov8" title="1">n.Return_code = "SUCCESS"
        n.Return_msg = "OK"
        return routing.HRES_RETURN</span>

}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible = document.getElementById('file0');
		files.addEventListener('change', onChange, false);
		function onChange() {
			visible.style.display = 'none';
			visible = document.getElementById(files.value);
			visible.style.display = 'block';
			window.scrollTo(0, 0);
		}
	})();
	</script>
</html>
